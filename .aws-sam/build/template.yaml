AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Application that establishes an API suited for working with documents
Metadata:
  AWS::ServerlessRepo::Application:
    Name: thetis-ims-document-api
    Description: Application that contains resources specific to Yarnliving
    Author: thetis-apps
    SpdxLicenseId: Apache-2.0
    LicenseUrl: ../../LICENSE.txt
    ReadmeUrl: ../../README.md
    Labels:
    - thetis-ims
    HomePageUrl: https://github.com/thetis-apps/DocumentApi
    SemanticVersion: 1.1.0
    SourceCodeUrl: https://github.com/thetis-apps/DocumentApi
Globals:
  Function:
    Timeout: 30
Parameters:
  FrontendUrl:
    Type: String
    Description: The URL at which the frontend is deployed
  ContextId:
    Type: String
    Description: Context that this application is handling events for.
    MinLength: '1'
  ClientId:
    Description: Key of the parameter that has your Thetis client id as its value.
    Type: AWS::SSM::Parameter::Value<String>
    Default: ThetisClientId
  ClientSecret:
    Description: Key of the parameter that has your Thetis client secret as its value.
    Type: AWS::SSM::Parameter::Value<String>
    Default: ThetisClientSecret
  ApiKey:
    Description: The api key that gives access to the context in Thetis IMS.
    Type: String
    MinLength: 1
  DevOpsEmail:
    Description: The email address to send mail to when messages in the dead letter
      queue.
    Type: String
    MinLength: 4
Resources:
  Api:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors:
        AllowHeaders: '''Access-Control-Allow-Origin,x-requested-with,content-type'''
        AllowOrigin:
          Fn::Sub: '''${FrontendUrl}'''
  GetPendingMultiPickingLists:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetPendingMultiPickingLists
      Handler: api.getPendingMultiPickingLists
      Runtime: nodejs12.x
      Environment:
        Variables:
          ClientId:
            Ref: ClientId
          ClientSecret:
            Ref: ClientSecret
          ApiKey:
            Ref: ApiKey
      Events:
        Request:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /pendingMultiPickingLists
            Method: get
  GetPendingPutAwayLists:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetPendingPutAwayLists
      Handler: api.getPendingPutAwayLists
      Runtime: nodejs12.x
      Environment:
        Variables:
          ClientId:
            Ref: ClientId
          ClientSecret:
            Ref: ClientSecret
          ApiKey:
            Ref: ApiKey
      Events:
        Request:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /pendingPutAwayLists
            Method: get
  GetPendingReplenishmentLists:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetPendingReplenishmentLists
      Handler: api.getPendingReplenishmentLists
      Runtime: nodejs12.x
      Environment:
        Variables:
          ClientId:
            Ref: ClientId
          ClientSecret:
            Ref: ClientSecret
          ApiKey:
            Ref: ApiKey
      Events:
        Request:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /pendingReplenishmentLists
            Method: get
  GetPendingStockTakingLists:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetPendingStockTakingLists
      Handler: api.getPendingStockTakingLists
      Runtime: nodejs12.x
      Environment:
        Variables:
          ClientId:
            Ref: ClientId
          ClientSecret:
            Ref: ClientSecret
          ApiKey:
            Ref: ApiKey
      Events:
        Request:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /pendingStockTakingLists
            Method: get
  PutMultiPickingList:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: PutMultiPickingList
      Handler: api.putMultiPickingList
      Runtime: nodejs12.x
      Environment:
        Variables:
          ClientId:
            Ref: ClientId
          ClientSecret:
            Ref: ClientSecret
          ApiKey:
            Ref: ApiKey
      Events:
        Request:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /multiPickingLists/{id}
            Method: put
  PutPutAwayList:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: PutPutAwayList
      Handler: api.putPutAwayList
      Runtime: nodejs12.x
      Environment:
        Variables:
          ClientId:
            Ref: ClientId
          ClientSecret:
            Ref: ClientSecret
          ApiKey:
            Ref: ApiKey
      Events:
        Request:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /putAwayLists/{id}
            Method: put
  PutReplenishmentList:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: PutReplenishmentList
      Handler: api.putReplenishmentList
      Runtime: nodejs12.x
      Environment:
        Variables:
          ClientId:
            Ref: ClientId
          ClientSecret:
            Ref: ClientSecret
          ApiKey:
            Ref: ApiKey
      Events:
        Request:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /replenishmentLists/{id}
            Method: put
  PutStockTakingList:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: PutStockTakingList
      Handler: api.putStockTakingList
      Runtime: nodejs12.x
      Environment:
        Variables:
          ClientId:
            Ref: ClientId
          ClientSecret:
            Ref: ClientSecret
          ApiKey:
            Ref: ApiKey
      Events:
        Request:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /stockTakingLists/{id}
            Method: put
Outputs:
  Api:
    Description: API Gateway endpoint URL for Prod stage for Multi Picking function
    Value:
      Fn::Sub: https://${Api}.execute-api.${AWS::Region}.amazonaws.com/Prod
